---
version: 3

tasks:
  build:
    desc: "Builds a local binary"
    cmds:
      - go build -o .build/gitgrab ./cmd/gitgrab

  clean:
    desc: "Removes all temporary files and directories"
    cmds:
      - rm -rf .build

  fmt:
    desc: "Formats the code"
    cmds:
      - go fmt ./...

  test:
    desc: "Runs unit tests"
    cmds:
      - go test ./...

  coverage:
    desc: "Prints the current test coverage"
    cmds:
      - go test ./... -cover

  release:
    desc: Build release artifacts for multiple platforms
    cmds:
      - task: clean
      - task: setup
      - task: release-darwin
      - task: release-linux
      - task: release-windows

  release-darwin:
    cmds: [task: release-darwin-amd64, task: release-darwin-arm64]
  release-linux:
    cmds: [task: release-linux-amd64, task: release-linux-arm64]
  release-windows:
    cmds: [task: release-windows-amd64, task: release-windows-arm64]

  release-core:
    internal: true
    env:
      GOOS: linux
      GOARCH: amd64
    cmds:
      - tar -czf {{.DIST_DIR}}/{{.BINARY_NAME}}-{{.VERSION}}-{{.GOOS}}-{{.GOARCH}}.tar.gz -C {{.BUILD_DIR}}/{{.GOOS}}-{{.GOARCH}} {{.BINARY_NAME}}{{.FILE_EXT}}

  release-linux-amd64:
    cmds:
      - task: build-linux-amd64
      - task: release-core
        vars: { GOOS: linux, GOARCH: amd64 }
      
  release-linux-arm64:
    cmds:
      - task: build-linux-arm64
      - task: release-core
        vars: { GOOS: linux, GOARCH: arm64 }
      
  release-windows-amd64:
    cmds:
      - task: build-windows-amd64
      - task: release-core
        vars: { GOOS: windows, GOARCH: amd64, FILE_EXT: ".exe" }
      
  release-windows-arm64:
    cmds:
      - task: build-windows-arm64
      - task: release-core
        vars: { GOOS: windows, GOARCH: arm64, FILE_EXT: ".exe" }
      
  release-darwin-amd64:
    cmds:
      - task: build-darwin-amd64
      - task: release-core
        vars: { GOOS: darwin, GOARCH: amd64 }
      
  release-darwin-arm64:
    cmds:
      - task: build-darwin-arm64
      - task: release-core
        vars: { GOOS: darwin, GOARCH: arm64 }
